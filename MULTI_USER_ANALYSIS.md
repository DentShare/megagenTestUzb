# Анализ: несколько пользователей с одной ролью

## Вывод: **ошибок не будет** — система поддерживает несколько пользователей с одной ролью.

---

## 1. Менеджеры (MANAGER)

| Аспект | Реализация | Результат |
|--------|------------|-----------|
| **Корзина** | FSM state привязан к `user_id` (telegram_id) | У каждого менеджера своя корзина |
| **Заказы** | `Order.manager_id` — ID менеджера, создавшего заказ | Каждый заказ привязан к одному менеджеру |
| **«Мои заказы»** | Фильтр `Order.manager_id == manager_user.id` | Каждый менеджер видит только свои заказы |
| **Детали заказа** | Проверка `order.manager_id != manager_user.id` → «Доступ запрещен» | Менеджер A не может открыть заказ менеджера B |

**Итог:** Несколько менеджеров работают параллельно без конфликтов.

---

## 2. Склад (WAREHOUSE)

| Аспект | Реализация | Результат |
|--------|------------|-----------|
| **Список заказов** | Показываются все заказы со статусом NEW/ASSEMBLY | Все склады видят одни и те же заказы |
| **«Взять в работу»** | Проверка `order.status == NEW` | Только первый, кто нажал, меняет статус на ASSEMBLY |
| **«Собрано»** | Проверка `order.status == ASSEMBLY` | Второй склад получит «Заказ не в статусе 'В сборке'» |
| **Привязка к складу** | Нет `warehouse_id` в Order | Заказ не привязан к конкретному складу |

**Итог:** Несколько складов могут работать с разными заказами. Если два склада нажмут «Взять» на один заказ, первый успешно возьмёт, второй получит «Заказ не найден или статус изменен».

---

## 3. Курьеры (COURIER)

| Аспект | Реализация | Результат |
|--------|------------|-----------|
| **Назначение** | `Order.courier_id` — ID курьера, взявшего заказ | Один заказ — один курьер |
| **«Завершить доставку»** | Проверка `courier_id == courier_user.id` | Только «свой» курьер может завершить |
| **Чужой заказ** | Сообщение «Этот заказ назначен другому курьеру» | Курьер B не может завершить заказ курьера A |

**Итог:** Несколько курьеров могут брать разные заказы. Конфликтов нет.

---

## 4. Админы (ADMIN)

| Аспект | Реализация | Результат |
|--------|------------|-----------|
| **Панель** | Общая для всех админов | Все админы видят одни и те же данные |
| **Действия** | Нет привязки к конкретному админу | Любой админ может управлять пользователями и клиниками |

**Итог:** Несколько админов могут работать одновременно.

---

## 5. Технические аспекты

| Компонент | Ключ | Результат |
|-----------|------|-----------|
| **FSM state** | `(user_id, chat_id)` | У каждого пользователя свой state |
| **DB session** | Создаётся на каждый запрос | Сессии не пересекаются |
| **User cache** | `telegram_id` | Кеш отдельно для каждого пользователя |
| **Rate limit** | `user_id` | Лимит отдельно для каждого пользователя |

---

## 6. Потенциальные нюансы (не ошибки)

1. **Склад:** Два склада могут одновременно открыть один и тот же заказ. Оба видят «Взять в работу». Первый нажавший берёт заказ, второй получит сообщение об ошибке — это ожидаемое поведение.

2. **Курьеры:** Все активные курьеры получают уведомление о новом заказе. Это сделано намеренно.

3. **Менеджеры:** Уведомления о статусе заказа идут только менеджеру, создавшему заказ (`order.manager_id`).

---

## Заключение

Система рассчитана на работу нескольких пользователей с одной ролью. Конфликтов и ошибок при одновременной работе не возникает.
