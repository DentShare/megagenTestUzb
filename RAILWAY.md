# Деплой бота Megagen на Railway

## 1. Создать проект на Railway

1. Зайдите на [railway.app](https://railway.app), войдите через GitHub.
2. **New Project** → **Deploy from GitHub repo** → выберите репозиторий с ботом.
3. Railway сам определит Python и соберёт проект.

## 2. Добавить PostgreSQL

1. В проекте нажмите **+ New** → **Database** → **PostgreSQL**.
2. Сервис БД появится в проекте. Railway автоматически создаст переменную **`DATABASE_URL`** и при линковке подставит её в сервис бота (см. ниже).

## 3. Привязать БД к сервису бота

1. Откройте сервис с ботом (ваш репозиторий).
2. Вкладка **Variables** → **Add Reference** (или **Connect** к PostgreSQL).
3. Выберите переменные из PostgreSQL-сервиса — обязательно **`DATABASE_URL`**.  
   Тогда в боте будет подставлен корректный URL, и конфиг сам переведёт его в формат `postgresql+asyncpg://...`.

## 4. Обязательные переменные окружения

В сервисе бота (вкладка **Variables**) задайте:

| Переменная      | Описание                          | Пример                    |
|-----------------|-----------------------------------|---------------------------|
| `BOT_TOKEN`     | Токен бота от @BotFather          | `123456:ABC-DEF...`       |
| `ADMIN_IDS`     | Telegram ID админов через запятую | `123456789,987654321`     |
| `DATABASE_URL`  | Обычно подставляется из PostgreSQL (см. п. 3) | — |

Остальные переменные из `config.py` можно не задавать — будут использованы значения по умолчанию (Redis не обязателен, печать отключена и т.д.).

## 5. Команда запуска

- Либо в корне репозитория есть **Procfile**: `worker: python main.py` — Railway возьмёт команду из него.
- Либо в настройках сервиса задайте **Start Command**:  
  `python main.py`

Сервис должен быть типа **Worker** (без публичного HTTP), если Railway спрашивает.

## 6. Первый запуск: таблицы в БД

После первого деплоя база пустая. Нужно один раз создать таблицы.

**Вариант А — через Railway CLI (рекомендуется):**

```bash
railway run python init_db.py
```

**Вариант Б — локально:**  
Подключитесь к БД Railway по выданному `DATABASE_URL`, затем выполните:

```bash
# Установите переменную DATABASE_URL как у Railway, затем:
python init_db.py
```

После этого перезапустите сервис бота (Redeploy). Бот должен подключиться к PostgreSQL и работать в режиме long polling.

## 7. Полезные переменные (по желанию)

- `LOG_LEVEL` — `DEBUG` / `INFO` / `WARNING` (по умолчанию `INFO`).
- `CATALOG_AUTO_SYNC` — `false`, если не хотите авто-загрузку каталога при старте (на Railway нет Excel-файла — будет использоваться каталог из репозитория).
- Redis на Railway можно добавить как отдельный плагин и задать `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD` — тогда FSM и кеш будут в Redis; без Redis используется память (для одного инстанса достаточно).

## 8. Проверка

- В логах сервиса должно быть: `Database connection successful`, затем `Bot started successfully`.
- Напишите боту в Telegram — должен ответить.

Если что-то не запускается — смотрите логи сервиса в Railway (вкладка **Deployments** → выберите деплой → **View Logs**).
